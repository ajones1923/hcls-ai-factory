/*
 * ========================================================
 *  Healthcare & Life Sciences Pipeline Configuration
 * ========================================================
 */

// Pipeline parameters
params {
    // Input/Output
    input           = null
    vcf             = null
    target          = null
    outdir          = "${launchDir}/results"

    // Pipeline mode: 'full', 'target', 'drug', 'demo', 'genomics_only'
    mode            = 'demo'

    // Genomics parameters
    genome          = 'GRCh38'
    bwa_index       = null
    known_sites     = null

    // RAG Chat parameters
    rag_model       = 'claude-3-sonnet'
    max_targets     = 5
    confidence_threshold = 0.7

    // Drug Discovery parameters
    num_molecules   = 20
    diversity       = 0.3
    max_mw          = 550
    docking_poses   = 10

    // NIM Service URLs
    molmim_url      = 'http://localhost:8001'
    diffdock_url    = 'http://localhost:8002'

    // Notification
    email           = null

    // Resource defaults
    max_memory      = '128.GB'
    max_cpus        = 32
    max_time        = '24.h'
    max_gpus        = 1
}

// Execution profiles
profiles {

    standard {
        process.executor = 'local'
    }

    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }

    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }

    dgx_spark {
        // Optimized for NVIDIA DGX Spark
        docker.enabled = true
        docker.runOptions = '--gpus all -u $(id -u):$(id -g)'

        process {
            withLabel: 'gpu' {
                containerOptions = '--gpus all'
                accelerator = 1
            }
            withLabel: 'high_memory' {
                memory = '64 GB'
            }
        }

        params {
            max_gpus = 1
            max_memory = '128.GB'
            max_cpus = 32
        }
    }

    slurm {
        process.executor = 'slurm'
        process.queue = 'gpu'
    }

    test {
        params {
            mode = 'demo'
            num_molecules = 5
            outdir = "${launchDir}/test_results"
        }
    }
}

// Process configuration
process {
    // Default resources
    cpus = 4
    memory = '8 GB'
    time = '2h'

    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2

    // Labels for resource allocation
    withLabel: 'process_low' {
        cpus = 2
        memory = '4 GB'
    }

    withLabel: 'process_medium' {
        cpus = 8
        memory = '32 GB'
    }

    withLabel: 'process_high' {
        cpus = 16
        memory = '64 GB'
    }

    withLabel: 'gpu' {
        cpus = 8
        memory = '32 GB'
        accelerator = 1
        containerOptions = '--gpus all'
    }

    // Container assignments
    withName: 'GENOMICS_.*' {
        container = 'nfcore/sarek:3.4.0'
    }

    withName: 'RAG_CHAT_.*' {
        container = 'hls-pipeline/rag-chat:latest'
    }

    withName: 'DRUG_DISCOVERY_.*' {
        container = 'hls-pipeline/drug-discovery:latest'
    }

    withName: 'MOLMIM_.*' {
        container = 'nvcr.io/nvidia/clara/bionemo-molmim:1.0'
        label = 'gpu'
    }

    withName: 'DIFFDOCK_.*' {
        container = 'nvcr.io/nvidia/clara/diffdock:1.0'
        label = 'gpu'
    }
}

// Manifest
manifest {
    name            = 'HLS-Pipeline'
    author          = 'Healthcare & Life Sciences Team'
    description     = 'End-to-end genomics to drug discovery pipeline'
    version         = '1.0.3'
    nextflowVersion = '>=23.10.0'
    mainScript      = 'main.nf'
    defaultBranch   = 'main'
}

// Reports
report {
    enabled = true
    file = "${params.outdir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/trace.tsv"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,peak_rss,peak_vmem'
}

dag {
    enabled = true
    file = "${params.outdir}/dag.html"
    overwrite = true
}

// Tower integration (optional)
tower {
    enabled = false
    // accessToken = secrets.TOWER_ACCESS_TOKEN
}
