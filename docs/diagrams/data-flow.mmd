%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#76B900', 'primaryTextColor': '#fff', 'lineColor': '#333'}}}%%

flowchart TB
    subgraph EXTERNAL["â˜ï¸ External Data Sources"]
        NCBI[("ğŸŒ NCBI GIAB FTP<br/>ftp-trace.ncbi.nlm.nih.gov")]
        S3[("ğŸŒ AWS S3<br/>Parabricks Sample Bundle")]
    end

    subgraph DOWNLOAD["ğŸ“¥ Download Phase"]
        direction TB
        IDX["ğŸ“‹ Index File<br/>hg002_illumina_2x250.index.tsv"]
        LANES["ğŸ“¦ Lane Files<br/>L001-L008 Ã— R1/R2<br/>~200GB total"]
        BUNDLE["ğŸ“¦ Reference Bundle<br/>parabricks_sample.tar.gz<br/>~11GB"]
    end

    subgraph PREP["ğŸ”§ Preparation Phase"]
        direction TB
        MERGE["ğŸ”€ Lane Merging<br/>zcat | gzip"]
        EXTRACT["ğŸ“‚ Extraction<br/>tar -xzf"]
    end

    subgraph INPUT["ğŸ“‚ Input Files"]
        direction TB
        R1[("ğŸ“„ HG002_R1.fastq.gz<br/>Forward Reads<br/>~100GB<br/>~400M reads")]
        R2[("ğŸ“„ HG002_R2.fastq.gz<br/>Reverse Reads<br/>~100GB<br/>~400M reads")]
        REF[("ğŸ“„ GRCh38.fa<br/>Reference Genome<br/>~3GB<br/>3.1B bases")]
        BWA_IDX[("ğŸ“„ GRCh38.fa.*<br/>BWA Index Files<br/>~6GB")]
    end

    subgraph FQ2BAM["ğŸ§¬ fq2bam Processing"]
        direction TB
        subgraph ALIGN["Step 1: Alignment"]
            A1["ğŸ” Seeding<br/>Find exact matches"]
            A2["ğŸ”— Chaining<br/>Connect seeds"]
            A3["ğŸ“ Smith-Waterman<br/>Optimal alignment"]
            A4["ğŸ“Š Scoring<br/>MAPQ calculation"]
        end
        subgraph SORT["Step 2: Sorting"]
            SORT1["ğŸ“Š Coordinate Sort<br/>chr:position ordering"]
        end
        subgraph DEDUP["Step 3: Deduplication"]
            DEDUP1["ğŸ”– Mark Duplicates<br/>PCR artifact flagging"]
        end
        A1 --> A2 --> A3 --> A4 --> SORT1 --> DEDUP1
    end

    subgraph BAM_OUT["ğŸ“ BAM Output"]
        BAM[("ğŸ“„ HG002.genome.bam<br/>Aligned Reads<br/>~100GB")]
        BAI[("ğŸ“„ HG002.genome.bam.bai<br/>BAM Index<br/>~10MB")]
        FLAGSTAT["ğŸ“Š Flagstat Report<br/>Mapping: 99.5%<br/>Duplicates: 15%<br/>Properly Paired: 98%"]
    end

    subgraph DEEPVAR["ğŸ§  DeepVariant Processing"]
        direction TB
        PILEUP["ğŸ–¼ï¸ Pileup Generation<br/>Visual encoding of reads"]
        CNN["ğŸ§  CNN Inference<br/>Inception-v3 model<br/>Genotype classification"]
        GENO["ğŸ“ Genotyping<br/>0/0, 0/1, 1/1<br/>Quality scoring"]
        PILEUP --> CNN --> GENO
    end

    subgraph VCF_OUT["ğŸ“ VCF Output"]
        VCF[("ğŸ“„ HG002.genome.vcf.gz<br/>Variant Calls<br/>~1-2GB<br/>~4M variants")]
        TBI[("ğŸ“„ HG002.genome.vcf.gz.tbi<br/>Tabix Index<br/>~2MB")]
    end

    subgraph VARIANTS["ğŸ“Š Variant Summary"]
        SNV["ğŸ”¹ SNVs<br/>~3.56M single nucleotide"]
        INDEL["ğŸ”¸ Indels<br/>~500K insertions/deletions"]
    end

    %% Data Flow Connections
    NCBI --> IDX --> LANES
    S3 --> BUNDLE
    LANES --> MERGE --> R1 & R2
    BUNDLE --> EXTRACT --> REF & BWA_IDX

    R1 --> FQ2BAM
    R2 --> FQ2BAM
    REF --> FQ2BAM
    BWA_IDX --> FQ2BAM

    FQ2BAM --> BAM
    BAM --> BAI
    BAM --> FLAGSTAT

    BAM --> DEEPVAR
    REF --> DEEPVAR

    DEEPVAR --> VCF
    VCF --> TBI
    VCF --> SNV & INDEL

    %% Styling
    classDef externalClass fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef downloadClass fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    classDef prepClass fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    classDef inputClass fill:#B3E5FC,stroke:#0288D1,stroke-width:2px
    classDef processClass fill:#76B900,stroke:#5a8f00,stroke-width:2px,color:#fff
    classDef outputClass fill:#FFE082,stroke:#FFA000,stroke-width:2px
    classDef summaryClass fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px

    class EXTERNAL externalClass
    class DOWNLOAD downloadClass
    class PREP prepClass
    class INPUT inputClass
    class FQ2BAM,DEEPVAR processClass
    class BAM_OUT,VCF_OUT outputClass
    class VARIANTS summaryClass
