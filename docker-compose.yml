# HCLS AI Factory — Full Stack Orchestrator
# Brings up all services with a single command.
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose up -d landing-page milvus  # Start specific services
#   docker compose --profile nims up -d     # Include GPU NIM services
#
# Requirements:
#   - Docker Compose v2.20+ (for 'include' support)
#   - NVIDIA GPU + drivers (for NIM services)
#   - NGC_API_KEY env var (for NIM services)

include:
  - genomics-pipeline/web-portal/docker-compose.yml
  - rag-chat-pipeline/docker-compose.yml
  - drug-discovery-pipeline/docker-compose.yml

services:
  # Landing page — service health dashboard
  landing-page:
    build: ./landing-page
    container_name: ai-factory-landing
    ports:
      - "8080:8080"
    environment:
      - LANDING_PORT=8080
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    restart: unless-stopped

  # Monitoring — Grafana dashboards (auto-provisioned)
  grafana:
    image: grafana/grafana-oss:11.0.0
    container_name: ai-factory-grafana
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./drug-discovery-pipeline/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./drug-discovery-pipeline/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    restart: unless-stopped

  # Monitoring — Prometheus metrics (with alert rules)
  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: ai-factory-prometheus
    ports:
      - "127.0.0.1:9099:9090"
    volumes:
      - ./drug-discovery-pipeline/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./drug-discovery-pipeline/monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    restart: unless-stopped

  # Intelligence Agents
  cart-agent:
    build: ../ai_agent_adds/cart_intelligence_agent
    container_name: ai-factory-cart-agent
    ports:
      - "8521:8521"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    depends_on:
      - landing-page
    restart: unless-stopped

  imaging-agent:
    build: ../ai_agent_adds/imaging_intelligence_agent/agent
    container_name: ai-factory-imaging-agent
    ports:
      - "8525:8525"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - NGC_API_KEY=${NGC_API_KEY}
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    depends_on:
      - landing-page
    restart: unless-stopped

  onco-agent:
    build: ../ai_agent_adds/precision_oncology_agent/agent
    container_name: ai-factory-onco-agent
    ports:
      - "8526:8526"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    depends_on:
      - landing-page
    restart: unless-stopped

  # Monitoring — Node Exporter (host metrics)
  node-exporter:
    image: prom/node-exporter:v1.8.0
    container_name: ai-factory-node-exporter
    ports:
      - "127.0.0.1:9100:9100"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
    restart: unless-stopped

volumes:
  grafana_data:
